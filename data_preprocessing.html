<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Farid Musayev">
<meta name="dcterms.date" content="2022-09-06">

<title>Farid Musayev - Part 1 | Data Preprocessing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Farid Musayev</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-projects" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Projects</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-projects">    
        <li>
    <a class="dropdown-item" href="./p1.html" rel="" target="">
 <span class="dropdown-text">Expected Goals Model</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./p3.html" rel="" target="">
 <span class="dropdown-text">Scientific Visualization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./p2.html" rel="" target="">
 <span class="dropdown-text">Soccer Analytics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./p4.html" rel="" target="">
 <span class="dropdown-text">Text Mining Project</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Part 1 | Data Preprocessing</h1>
<p class="subtitle lead">Preprocessing raw data with pandas</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Farid Musayev </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 6, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>In this section, I will demonstrate several steps that are required to preprocess data that will be used for building Expected Goals (xG) Model. Most of preprocessing steps will be implemented using <code>pandas</code>.</p>
<p>In addition to pandas, the following packages need to be imported:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ast</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are different publicly available soccer match event datasets. For this model, I decided to work with female soccer match event data due to a high granularity of event descriptions provided by the vendor, Statsbomb. This granularity can help me in building a sophisticated model and design features that can increase its accuracy. To learn more about other available datasets released by Statsbomb, feel free to visit <a href="https://github.com/statsbomb/open-data">this link</a>.</p>
<p>To extract data from Statsbomb API, different methodologies are available. I prefer to work with <a href="https://socceraction.readthedocs.io/en/latest/#"><code>socceraction</code></a> library that allows me to extract data in a convenient <code>pandas.DataFrame</code> format.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import wyscout public match event data loader from socceraction library</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> socceraction.data.statsbomb <span class="im">import</span> StatsBombLoader </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># remove credentials warning from statsbomb api since we work with public data </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, message<span class="op">=</span><span class="st">"credentials were not supplied. open data access only"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># load public wyscout data</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>stbm_data <span class="op">=</span> StatsBombLoader()</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># read available competitions and filter out only female related ones</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>competitions <span class="op">=</span> stbm_data.competitions()</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>female_comps <span class="op">=</span> competitions.loc[competitions[<span class="st">'competition_gender'</span>] <span class="op">==</span> <span class="st">'female'</span>, :].reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>female_comps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">season_id</th>
<th data-quarto-table-cell-role="th">competition_id</th>
<th data-quarto-table-cell-role="th">competition_name</th>
<th data-quarto-table-cell-role="th">country_name</th>
<th data-quarto-table-cell-role="th">competition_gender</th>
<th data-quarto-table-cell-role="th">season_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>90</td>
<td>37</td>
<td>FA Women's Super League</td>
<td>England</td>
<td>female</td>
<td>2020/2021</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>42</td>
<td>37</td>
<td>FA Women's Super League</td>
<td>England</td>
<td>female</td>
<td>2019/2020</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>4</td>
<td>37</td>
<td>FA Women's Super League</td>
<td>England</td>
<td>female</td>
<td>2018/2019</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3</td>
<td>49</td>
<td>NWSL</td>
<td>United States of America</td>
<td>female</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>106</td>
<td>53</td>
<td>UEFA Women's Euro</td>
<td>Europe</td>
<td>female</td>
<td>2022</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>30</td>
<td>72</td>
<td>Women's World Cup</td>
<td>International</td>
<td>female</td>
<td>2019</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As can be seen, data is available for four different female soccer competitions. Three seasons of <strong>FA Women’s Super League</strong>, one season of <strong>NWSL</strong> and two competitions involving national teams, <strong>UEFA Women’s Euro 2022</strong> and <strong>Women’s World Cup 2019</strong>.</p>
<p>Below code illustrates steps required to read event data on each game from the aforementioned competitions and save it as <code>.csv</code> file. I also save all <code>.csv</code> files into a single <code>all_events</code> dataframe. Later, this will allow me to extract an event of interest from all games at once.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># names of folders to save files</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>dir_names <span class="op">=</span> [<span class="st">'FAWSL_2021'</span>, <span class="st">'FAWSL_1920'</span>, <span class="st">'FAWSL_1819'</span>, <span class="st">'NWSL'</span>, <span class="st">'EURO_2022'</span>, <span class="st">'WC_2019'</span>]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for each competition save all games as .csv files</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, j <span class="kw">in</span> female_comps.loc[:, [<span class="st">'season_id'</span>, <span class="st">'competition_id'</span>]].iterrows():</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># j[0] = season_id, j[1] = competition_id</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    games <span class="op">=</span> stbm_data.games(j[<span class="dv">1</span>], j[<span class="dv">0</span>]).loc[:, <span class="st">'game_id'</span>]</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> games:</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        events <span class="op">=</span> stbm_data.events(k)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        events.to_csv(<span class="ss">f'.data/</span><span class="sc">{</span>dir_names[i]<span class="sc">}</span><span class="ss">/games/</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">.csv'</span>, index <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># concatenate all events into a single data frame</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>all_events <span class="op">=</span> pd.DataFrame()</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> dir_names:</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    games <span class="op">=</span> os.listdir(<span class="ss">f'.data/</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/games'</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> games:</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_csv(<span class="ss">f'.data/</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/games/</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        all_events <span class="op">=</span> pd.concat([all_events, df])</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># rest index and save as .csv file</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>all_events <span class="op">=</span> all_events.reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>all_events.to_csv(<span class="st">'.data/all_events.csv'</span>, index <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-scrolled="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>all_events.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">game_id</th>
<th data-quarto-table-cell-role="th">event_id</th>
<th data-quarto-table-cell-role="th">period_id</th>
<th data-quarto-table-cell-role="th">team_id</th>
<th data-quarto-table-cell-role="th">player_id</th>
<th data-quarto-table-cell-role="th">type_id</th>
<th data-quarto-table-cell-role="th">type_name</th>
<th data-quarto-table-cell-role="th">index</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">team_name</th>
<th data-quarto-table-cell-role="th">duration</th>
<th data-quarto-table-cell-role="th">extra</th>
<th data-quarto-table-cell-role="th">related_events</th>
<th data-quarto-table-cell-role="th">player_name</th>
<th data-quarto-table-cell-role="th">position_id</th>
<th data-quarto-table-cell-role="th">position_name</th>
<th data-quarto-table-cell-role="th">location</th>
<th data-quarto-table-cell-role="th">under_pressure</th>
<th data-quarto-table-cell-role="th">counterpress</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>3764230</td>
<td>3f5dde74-d91b-44ea-9a1f-88e84da555ab</td>
<td>1</td>
<td>749</td>
<td>NaN</td>
<td>35</td>
<td>Starting XI</td>
<td>1</td>
<td>1900-01-01 00:00:00.000</td>
<td>0</td>
<td>...</td>
<td>Tottenham Hotspur Women</td>
<td>0.0</td>
<td>{'tactics': {'formation': 4231, 'lineup': [{'p...</td>
<td>[]</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>3764230</td>
<td>e4fefe61-4e08-47e0-be4d-2276388e6eb4</td>
<td>1</td>
<td>972</td>
<td>NaN</td>
<td>35</td>
<td>Starting XI</td>
<td>2</td>
<td>1900-01-01 00:00:00.000</td>
<td>0</td>
<td>...</td>
<td>West Ham United LFC</td>
<td>0.0</td>
<td>{'tactics': {'formation': 433, 'lineup': [{'pl...</td>
<td>[]</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3764230</td>
<td>ff9a99d3-3efd-45c2-8736-a8a93dd02638</td>
<td>1</td>
<td>972</td>
<td>NaN</td>
<td>18</td>
<td>Half Start</td>
<td>3</td>
<td>1900-01-01 00:00:00.000</td>
<td>0</td>
<td>...</td>
<td>West Ham United LFC</td>
<td>0.0</td>
<td>{}</td>
<td>['5fb7026c-83aa-4490-96b1-a55825c4dcb8']</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>False</td>
</tr>
</tbody>
</table>

<p>3 rows × 26 columns</p>
</div>
</div>
</div>
<p>There is a wide range of data describing each event. Since xG model evaluates the probability of a shot to result in a goal, I can filter only <code>shot</code> events, extract columns of interest to this event and test these columns after preprocessing in the model building phase.</p>
<div class="cell" data-scrolled="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># list all features to select ones required for xG model</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>all_events.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>Index(['game_id', 'event_id', 'period_id', 'team_id', 'player_id', 'type_id',
       'type_name', 'index', 'timestamp', 'minute', 'second', 'possession',
       'possession_team_id', 'possession_team_name', 'play_pattern_id',
       'play_pattern_name', 'team_name', 'duration', 'extra', 'related_events',
       'player_name', 'position_id', 'position_name', 'location',
       'under_pressure', 'counterpress'],
      dtype='object')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter event type_name = 'Shot' and leave only required columns </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>shots <span class="op">=</span> all_events.loc[all_events[<span class="st">'type_name'</span>] <span class="op">==</span> <span class="st">'Shot'</span>, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                       [<span class="st">'minute'</span>, <span class="st">'player_name'</span>, <span class="st">'team_name'</span>, <span class="st">'type_name'</span>, <span class="st">'play_pattern_name'</span>, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'position_name'</span>, <span class="st">'location'</span>, <span class="st">'under_pressure'</span>, <span class="st">'extra'</span>]].reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following columns are dropped due to their irrelevance to the context of the model: <em>‘game_id’, ‘event_id’, ‘period_id’, ‘team_id’, ‘player_id’, ‘type_id’, ‘index’, ‘timestamp’, ‘minute’, ‘second’, ‘possession’, ‘possession_team_id’, ‘possession_team_name’, ‘play_pattern_id’, ‘duration’, ‘related_events’, ‘position_id’</em>.</p>
<p>As you can see, a majority of these events are <code>id</code> identifiers. For example, <code>play_pattern_id</code> is ommited while <code>play_pattern</code> is left in the dataframe. The rest of the columns include time- or possession-related information which will not make any use in our case.</p>
<p>One of the most important columns, as we will see later, is <code>location</code> of the shot. I extract required (x, y) coordinates from a given list and save them as separate columns for a simpler use case during feature engineering phase.</p>
<p>It is important to note that when dataframes are saved as <code>.csv</code> files, all of them are converted into a raw string format. Thus, when reading these dataframes, one needs to convert columns containing specific datatypes into a python readable format. For that, I use <code>ast</code> package and, specifically, <code>ast.literal_eval()</code> function. This allows me to convert a string of a list into a python readable list object.</p>
<div class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># unlist location column into (x, y) and remove it</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>shots.loc[:, <span class="st">'location'</span>] <span class="op">=</span> shots.loc[:, <span class="st">'location'</span>].<span class="bu">apply</span>(ast.literal_eval)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>shots.loc[:, <span class="st">'x_start'</span>] <span class="op">=</span> shots.loc[:, <span class="st">'location'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x[<span class="dv">0</span>])</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>shots.loc[:, <span class="st">'y_start'</span>] <span class="op">=</span> shots.loc[:, <span class="st">'location'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x[<span class="dv">1</span>])</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>shots <span class="op">=</span> shots.drop(columns <span class="op">=</span> <span class="st">'location'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-scrolled="true" data-execution_count="106">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>shots.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">player_name</th>
<th data-quarto-table-cell-role="th">team_name</th>
<th data-quarto-table-cell-role="th">type_name</th>
<th data-quarto-table-cell-role="th">play_pattern_name</th>
<th data-quarto-table-cell-role="th">position_name</th>
<th data-quarto-table-cell-role="th">under_pressure</th>
<th data-quarto-table-cell-role="th">extra</th>
<th data-quarto-table-cell-role="th">x_start</th>
<th data-quarto-table-cell-role="th">y_start</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>7</td>
<td>Lucy Quinn</td>
<td>Tottenham Hotspur Women</td>
<td>Shot</td>
<td>Regular Play</td>
<td>Right Wing</td>
<td>False</td>
<td>{'shot': {'statsbomb_xg': 0.013642391, 'end_lo...</td>
<td>95.9</td>
<td>58.9</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>10</td>
<td>Rianna Dean</td>
<td>Tottenham Hotspur Women</td>
<td>Shot</td>
<td>From Free Kick</td>
<td>Center Forward</td>
<td>False</td>
<td>{'shot': {'statsbomb_xg': 0.04084396, 'end_loc...</td>
<td>106.1</td>
<td>54.3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>11</td>
<td>Angela Addison</td>
<td>Tottenham Hotspur Women</td>
<td>Shot</td>
<td>From Free Kick</td>
<td>Left Wing</td>
<td>True</td>
<td>{'shot': {'statsbomb_xg': 0.13687119, 'end_loc...</td>
<td>110.0</td>
<td>28.2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>13</td>
<td>Kit Graham</td>
<td>Tottenham Hotspur Women</td>
<td>Shot</td>
<td>From Throw In</td>
<td>Center Attacking Midfield</td>
<td>False</td>
<td>{'shot': {'statsbomb_xg': 0.12462413, 'end_loc...</td>
<td>113.2</td>
<td>40.4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>16</td>
<td>Kit Graham</td>
<td>Tottenham Hotspur Women</td>
<td>Shot</td>
<td>From Counter</td>
<td>Center Attacking Midfield</td>
<td>False</td>
<td>{'shot': {'statsbomb_xg': 0.02380701, 'end_loc...</td>
<td>95.2</td>
<td>39.8</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The column named <code>extra</code> contains additional information describing <code>shot</code> event. This is where we can observe that Statsbomb provides a high level of event data granularity. For example, below you can see that for each shot, the location of all players, specifically opposing team’s goalkeeper, within a visible video frame is recorded. In addition, there is data about <code>body_part</code> with which a shot was implemented, <code>technique</code> (which as per event data description guide is “name of the technique used for this shot”), <code>open_goal</code> which is a boolean variable that describes if a shot was taken with an open goal, <code>follows_dribble</code> which is a boolean variable that describes if a taken shot was followed by dribble or not and <code>first_time</code> which is a boolean variable that describes if a shot was taken with the first touch or not. Due to vendor specifications, only boolean variables with <code>True</code> state appear in <code>extra</code> column; thus, I have to specify <code>False</code> state for all other cases explicitly.</p>
<p>As you can see, variables <code>follows_dribble</code> and <code>open_goal</code> are missing from below instance of <code>extra</code> column due to <code>False</code> state.</p>
<div class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>shots.loc[:, <span class="st">'extra'</span>][<span class="dv">148</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="150">
<pre><code>{'shot': {'open_goal': True,
  'statsbomb_xg': 0.84770715,
  'end_location': [120.0, 39.0, 0.9],
  'body_part': {'id': 40, 'name': 'Right Foot'},
  'type': {'id': 87, 'name': 'Open Play'},
  'outcome': {'id': 97, 'name': 'Goal'},
  'first_time': True,
  'technique': {'id': 91, 'name': 'Half Volley'},
  'freeze_frame': [{'location': [111.4, 38.3],
    'player': {'id': 4647, 'name': 'So-Yun Ji'},
    'position': {'id': 13, 'name': 'Right Center Midfield'},
    'teammate': True},
   {'location': [108.8, 42.9],
    'player': {'id': 4636, 'name': 'Maria Thorisdottir'},
    'position': {'id': 2, 'name': 'Right Back'},
    'teammate': True},
   {'location': [110.1, 53.6],
    'player': {'id': 4961, 'name': 'Samantha May Kerr'},
    'position': {'id': 21, 'name': 'Left Wing'},
    'teammate': True},
   {'location': [106.3, 51.4],
    'player': {'id': 10108, 'name': 'Pernille Mosegaard Harder'},
    'position': {'id': 17, 'name': 'Right Wing'},
    'teammate': True},
   {'location': [110.8, 35.7],
    'player': {'id': 46738, 'name': 'Emma Bissell'},
    'position': {'id': 16, 'name': 'Left Midfield'},
    'teammate': False},
   {'location': [110.1, 39.8],
    'player': {'id': 36801, 'name': 'Aimee Palmer'},
    'position': {'id': 13, 'name': 'Right Center Midfield'},
    'teammate': False},
   {'location': [116.1, 42.8],
    'player': {'id': 16376, 'name': 'Sophie Baggaley'},
    'position': {'id': 1, 'name': 'Goalkeeper'},
    'teammate': False},
   {'location': [116.1, 45.7],
    'player': {'id': 16381, 'name': 'Gemma Evans'},
    'position': {'id': 5, 'name': 'Left Center Back'},
    'teammate': False},
   {'location': [110.5, 46.1],
    'player': {'id': 15618, 'name': 'Jasmine Matthews'},
    'position': {'id': 3, 'name': 'Right Center Back'},
    'teammate': False},
   {'location': [111.2, 50.0],
    'player': {'id': 24922, 'name': 'Florence Allen'},
    'position': {'id': 2, 'name': 'Right Back'},
    'teammate': False},
   {'location': [114.5, 49.3],
    'player': {'id': 24239, 'name': 'Jemma Elizabeth Purfield'},
    'position': {'id': 6, 'name': 'Left Back'},
    'teammate': False}]}}</code></pre>
</div>
</div>
<p>In addition to above-mentioned data, I also extract contenxtual information from <code>extra</code> column. These are <code>type</code>, <code>statsbomb_xg</code> and <code>outcome</code> variables. The last one is important for knowing if a taken shot results in a goal or not. The variable <code>type</code> will help me to filter out only open play situations and discard outlying conditions where a shot is taken directly from corner, free-kick, penalty or kick-off. These are situations that can largely skew performance of the proposed xG model, and it is better to build a separate model that focuses only on them.</p>
<p>I unpack <code>extra</code> column that consists of dictionaries, extract required data and save it as separate columns in the dataframe.</p>
<div class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert 'extra' column to dict readable format using ast.literal_eval</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>shots_extra <span class="op">=</span> shots.loc[:, <span class="st">'extra'</span>].<span class="bu">apply</span>(ast.literal_eval).reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># specify which features to extract from 'extra' column</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>keys <span class="op">=</span> [<span class="st">'follows_dribble'</span>, <span class="st">'first_time'</span>, <span class="st">'open_goal'</span>, <span class="st">'statsbomb_xg'</span>, <span class="op">\</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'type'</span>, <span class="st">'technique'</span>, <span class="st">'body_part'</span>, <span class="st">'outcome'</span>]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># save selected features in a dataframe</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>extra_features <span class="op">=</span> pd.DataFrame(np.nan, columns <span class="op">=</span> keys, index <span class="op">=</span> <span class="bu">range</span>(shots.shape[<span class="dv">0</span>]))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, j <span class="kw">in</span> shots_extra.iteritems():</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">list</span>(j[<span class="st">'shot'</span>].keys()):</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="kw">in</span> [<span class="st">'type'</span>, <span class="st">'technique'</span>, <span class="st">'body_part'</span>, <span class="st">'outcome'</span>]:</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>            extra_features.loc[i, k] <span class="op">=</span> j[<span class="st">'shot'</span>][k][<span class="st">'name'</span>]</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> k <span class="kw">in</span> keys:</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>            extra_features.loc[i, k] <span class="op">=</span> j[<span class="st">'shot'</span>][k]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> k <span class="op">==</span> <span class="st">'freeze_frame'</span>:</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>            extra_features.loc[i, k] <span class="op">=</span> [{<span class="st">'freeze_frame'</span>:j[<span class="st">'shot'</span>][k]}]</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> (k <span class="op">==</span> <span class="st">'end_location'</span>):</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>            extra_features.loc[i, <span class="st">'end_loc'</span>] <span class="op">=</span> [{<span class="st">'end_loc'</span>:j[<span class="st">'shot'</span>][k]}]</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># fill NAs with boolean = False (technically, these are not NAs but just undeclared False values)</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>extra_features <span class="op">=</span> extra_features.fillna(value <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co"># transform columns with boolean values into integers </span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>extra_features.loc[:, [<span class="st">'follows_dribble'</span>, <span class="st">'first_time'</span>, <span class="st">'open_goal'</span>]] <span class="op">=</span> <span class="op">\</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>extra_features.loc[:, [<span class="st">'follows_dribble'</span>, <span class="st">'first_time'</span>, <span class="st">'open_goal'</span>]].astype(<span class="bu">int</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>shots.loc[:, <span class="st">'under_pressure'</span>] <span class="op">=</span> shots.loc[:, <span class="st">'under_pressure'</span>].astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>shots <span class="op">=</span> pd.concat([shots.drop(columns <span class="op">=</span> [<span class="st">'extra'</span>, <span class="st">'type_name'</span>]), extra_features], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>shots.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">player_name</th>
<th data-quarto-table-cell-role="th">team_name</th>
<th data-quarto-table-cell-role="th">play_pattern_name</th>
<th data-quarto-table-cell-role="th">position_name</th>
<th data-quarto-table-cell-role="th">under_pressure</th>
<th data-quarto-table-cell-role="th">x_start</th>
<th data-quarto-table-cell-role="th">y_start</th>
<th data-quarto-table-cell-role="th">follows_dribble</th>
<th data-quarto-table-cell-role="th">first_time</th>
<th data-quarto-table-cell-role="th">open_goal</th>
<th data-quarto-table-cell-role="th">statsbomb_xg</th>
<th data-quarto-table-cell-role="th">type</th>
<th data-quarto-table-cell-role="th">technique</th>
<th data-quarto-table-cell-role="th">body_part</th>
<th data-quarto-table-cell-role="th">outcome</th>
<th data-quarto-table-cell-role="th">end_loc</th>
<th data-quarto-table-cell-role="th">freeze_frame</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>7</td>
<td>Lucy Quinn</td>
<td>Tottenham Hotspur Women</td>
<td>Regular Play</td>
<td>Right Wing</td>
<td>0</td>
<td>95.9</td>
<td>58.9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.013642</td>
<td>Open Play</td>
<td>Normal</td>
<td>Left Foot</td>
<td>Saved</td>
<td>[{'end_loc': [116.7, 44.9, 1.2]}]</td>
<td>[{'freeze_frame': [{'location': [119.6, 42.3],...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>10</td>
<td>Rianna Dean</td>
<td>Tottenham Hotspur Women</td>
<td>From Free Kick</td>
<td>Center Forward</td>
<td>0</td>
<td>106.1</td>
<td>54.3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.040844</td>
<td>Open Play</td>
<td>Normal</td>
<td>Right Foot</td>
<td>Off T</td>
<td>[{'end_loc': [120.0, 41.6, 4.2]}]</td>
<td>[{'freeze_frame': [{'location': [118.8, 43.2],...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>11</td>
<td>Angela Addison</td>
<td>Tottenham Hotspur Women</td>
<td>From Free Kick</td>
<td>Left Wing</td>
<td>1</td>
<td>110.0</td>
<td>28.2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.136871</td>
<td>Open Play</td>
<td>Normal</td>
<td>Left Foot</td>
<td>Saved</td>
<td>[{'end_loc': [117.6, 36.7, 0.4]}]</td>
<td>[{'freeze_frame': [{'location': [111.3, 39.8],...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>13</td>
<td>Kit Graham</td>
<td>Tottenham Hotspur Women</td>
<td>From Throw In</td>
<td>Center Attacking Midfield</td>
<td>0</td>
<td>113.2</td>
<td>40.4</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.124624</td>
<td>Open Play</td>
<td>Normal</td>
<td>Head</td>
<td>Post</td>
<td>[{'end_loc': [120.0, 37.9, 2.9]}]</td>
<td>[{'freeze_frame': [{'location': [105.8, 46.6],...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>16</td>
<td>Kit Graham</td>
<td>Tottenham Hotspur Women</td>
<td>From Counter</td>
<td>Center Attacking Midfield</td>
<td>0</td>
<td>95.2</td>
<td>39.8</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.023807</td>
<td>Open Play</td>
<td>Normal</td>
<td>Left Foot</td>
<td>Post</td>
<td>[{'end_loc': [120.0, 37.3, 2.9]}]</td>
<td>[{'freeze_frame': [{'location': [97.8, 49.4], ...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Also, I would like to extract opposing team’s goalkeeper location during each executed shot. These coordinates are contained in <code>freeze_frame</code> column.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write a custom function to unpack dictionaries within freeze_frame column</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ff_unpacking(players):</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    players <span class="op">=</span> players[<span class="dv">0</span>][<span class="st">'freeze_frame'</span>]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> players:</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i[<span class="st">'position'</span>][<span class="st">'name'</span>] <span class="op">==</span> <span class="st">'Goalkeeper'</span> <span class="kw">and</span> i[<span class="st">'teammate'</span>] <span class="op">==</span> <span class="va">False</span>:</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>            gk_loc <span class="op">=</span> i[<span class="st">'location'</span>]</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> gk_loc</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>shots.loc[:, <span class="st">'gk_loc'</span>] <span class="op">=</span> shots.loc[:, <span class="st">'freeze_frame'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: ff_unpacking(x))</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that there are 42 None instances where goalkeeper location was incorrectly labeled.</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>shots <span class="op">=</span> shots.loc[<span class="op">~</span>shots.loc[:, <span class="st">'gk_loc'</span>].isnull(), :].reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># save (x, y) coordinates of a goalkeeper as separate columns</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>shots.loc[:, <span class="st">'gk_loc_x'</span>] <span class="op">=</span> shots.loc[:, <span class="st">'gk_loc'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x[<span class="dv">0</span>])</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>shots.loc[:, <span class="st">'gk_loc_y'</span>] <span class="op">=</span> shots.loc[:, <span class="st">'gk_loc'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, I save my <code>shots</code> dataframe as <code>.csv</code> file.</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>shots.to_csv(<span class="st">'.data/shots.csv'</span>, index <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is the end of preprocessing stage for data that will be used in the proposed xG model. Now, we can move on to the model building phase that will focus on exploratory data analysis, feature engineering and model selection.</p>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>